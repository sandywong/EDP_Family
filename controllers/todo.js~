
var config = require('../config')
, db = config.db;
var http = require('http');
var login = require('./login');

exports.index = function(req, res) {
    if(!req.session.userName)
        return res.redirect('/login');
    login.countDown(req, res);
    db.query('select * from todo order by finished asc, id asc limit 50', function(err, rows) {
        if(err) return next(err);
        res.render('index', {todos: rows});
    });
};

exports.new = function(req, res, next) {
    if(!req.session.userName)
        return res.redirect('/login');
    login.countDown(req, res);
    var title = req.body.title || '';
    title = title.trim();
    if(!title) {
        return res.render('error', {message: '标题是必须的'});
    }
    db.query('insert into todo set title=?, post_date=now()', [title], function(err, result) {
        if(err) return next(err);
        res.redirect('/');
    });
};

exports.view = function(req, res, next) {
    res.redirect('/');
};

exports.edit = function(req, res, next) {
    if(!req.session.userName)
        return res.redirect('/login');
    login.countDown(req, res);
    var id = req.params.id;
    db.query('select * from todo where id=?', [id], function(err, rows) {
        if(err) return next(err);
        if(rows && rows.length > 0) {
            var row = rows[0];
            res.render('todo/edit', {todo: row});
        } else {
            next();
        }
    });
};

exports.save = function(req, res, next) {
    if(!req.session.userName)
        return res.redirect('/login');
    login.countDown(req, res);
    var id = req.params.id;
    var title = req.body.title || '';
    title = title.trim();
    if(!title) {
        return res.render('error', {message: '标题是必须的'});
    }
    db.query('update todo set title=? where id=?', [title, id], function(err, result) {
        if(err) return next(err);
        res.redirect('/');
    });
};

exports.delete = function(req, res, next) {
    if(!req.session.userName)
        return res.redirect('/login');
    login.countDown(req, res);
    var id = req.params.id;
    db.query('delete from todo where id = ?', [id], function(err) {
        if(err) return next(err);
        res.redirect('/');
    });
};

exports.finish = function(req, res, next) {
    if(!req.session.userName)
        return res.redirect('/login');
    login.countDown(req, res);
    var finished = req.query.status === 'yes' ? 1 : 0;
    var id = req.params.id;
    db.query('update todo set finished=? where id=?', [finished, id], function(err, result) {
        if(err) return next(err);
        res.redirect('/');
    });
};

exports.export2Xls = function(req, res, next){
    if(!req.session.userName)
        return res.redirect('/login');
    login.countDown(req, res);
    db.query('select * from todo order by finished asc, id asc', function(err, rows){
        if(err) return next(err);
        res.writeHead(200, {
            'Content-Type':'application/vnd.ms-excel',
            'Content-Disposition':'filename=test.xls'
        });
        res.write("<html xmlns=\"http://www.w3.org/1999/xhtml\"><head><meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /></head><body><table align=\"center\" width=\"1000\"> ");
        res.write("<tr><td>待办事项</td><td>是否完成</td></tr>");

        for(var i = 0; i < rows.length; i++){
            res.write("<tr><td>" + rows[i]['title'] + "</td><td>");
            if(rows[i]['finished'])
                res.write("是");
            else
                res.write("否");
            res.write("</td></tr>");
        }
        res.end("</table></body>");
    });
}
